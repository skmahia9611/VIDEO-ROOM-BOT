<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premium Video Player for Telegram</title>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;700&display=swap" rel="stylesheet">
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    :root {
      --bg-color: #121212;
      --primary-surface-color: #1e1e1e;
      --secondary-surface-color: #272727;
      --text-primary: #f1f1f1;
      --text-secondary: #aaa;
      --accent-color: #3ea6ff;
      --hover-bg-color: #333;
      --scrollbar-thumb-color: #555;
      --scrollbar-track-color: var(--primary-surface-color);
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Hind Siliguri', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
    }

    .app-container {
      display: flex;
      height: 100vh;
      width: 100%;
      opacity: 0; /* Initially hidden for login */
      transition: opacity 0.5s ease-in-out;
    }
    
    .app-container.visible {
      opacity: 1;
    }

    .login-screen {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-size: 1.2rem;
    }

    /* Player Section */
    .player-section {
      flex: 3;
      display: flex;
      flex-direction: column;
      background-color: #000;
    }

    .player-wrapper {
      position: relative;
      width: 100%;
      background-color: #000;
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-wrapper iframe,
    .player-wrapper video {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .loading-indicator, .error-message {
      font-size: 1.2rem;
      color: var(--text-secondary);
    }

    /* Playlist Section */
    .playlist-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--primary-surface-color);
      overflow-y: auto;
      padding: 16px 8px;
    }
    
    .playlist-header {
        font-size: 1.1rem;
        font-weight: 700;
        padding: 0 8px 16px 8px;
        color: var(--text-primary);
        border-bottom: 1px solid var(--secondary-surface-color);
        margin-bottom: 16px;
    }
    
    .welcome-message {
        font-size: 0.9rem;
        color: var(--text-secondary);
        padding: 0 8px 10px;
    }

    .video-feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .video-card {
      cursor: pointer;
      display: flex;
      gap: 12px;
      padding: 8px;
      border-radius: 8px;
      transition: background-color 0.2s ease-in-out;
      border: 2px solid transparent;
    }

    .video-card:hover {
      background-color: var(--hover-bg-color);
    }
    
    .video-card.active {
      background-color: var(--secondary-surface-color);
      border-color: var(--accent-color);
    }

    .thumbnail-container {
      position: relative;
      width: 140px;
      flex-shrink: 0;
    }
    
    .video-card.active .thumbnail-container::after {
        content: '▶ এখন চলছে';
        position: absolute;
        bottom: 5px;
        left: 5px;
        background-color: var(--accent-color);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 700;
    }

    .thumbnail-container img {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      display: block;
      border-radius: 8px;
    }

    .video-duration {
      position: absolute;
      bottom: 5px;
      right: 5px;
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .video-card.active .video-duration {
        display: none;
    }

    .video-meta {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-top: 4px;
      overflow: hidden;
    }

    .video-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 6px 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .video-info {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Custom Scrollbar */
    .playlist-section::-webkit-scrollbar {
      width: 8px;
    }
    .playlist-section::-webkit-scrollbar-track {
      background: var(--scrollbar-track-color);
    }
    .playlist-section::-webkit-scrollbar-thumb {
      background-color: var(--scrollbar-thumb-color);
      border-radius: 10px;
      border: 2px solid var(--scrollbar-track-color);
    }

    /* Responsive adjustments for smaller screens */
    @media (max-width: 850px) {
      .app-container {
        flex-direction: column;
        height: auto;
        overflow: auto;
      }
      .player-section, .playlist-section {
        flex: none;
        width: 100%;
      }
      .playlist-section {
        height: auto;
        max-height: 60vh;
      }
      .thumbnail-container {
        width: 120px;
      }
    }
  </style>
</head>
<body>

  <div class="login-screen" id="login-screen">
      <div class="loading-indicator">সংযোগ করা হচ্ছে...</div>
  </div>

  <div class="app-container" id="app-container">
    <div class="player-section">
      <div class="player-wrapper" id="player-container"></div>
    </div>
    <div class="playlist-section">
      <div class="playlist-header">ভিডিও তালিকা</div>
      <div class="welcome-message" id="welcome-message"></div>
      <div class="video-feed" id="video-feed"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const VideoPlayerApp = {
      config: {
        videos: [] // This will be loaded from Firebase
      },
      
      firebaseConfig: {
        apiKey: "AIzaSyA6JPDxbD5k1S-7bNikp6U_vFALPFl_fto",
        authDomain: "daily-paybot.firebaseapp.com",
        databaseURL: "https://daily-paybot-default-rtdb.firebaseio.com",
        projectId: "daily-paybot",
        storageBucket: "daily-paybot.firebasestorage.app",
        messagingSenderId: "962422978466",
        appId: "1:962422978466:web:43a3db97932bf82766e4fb"
      },

      state: {
        currentHlsInstance: null,
        activeVideoElement: null,
        lastTap: 0,
        telegramUser: null
      },

      elements: {
        playerContainer: document.getElementById('player-container'),
        videoFeed: document.getElementById('video-feed'),
        loginScreen: document.getElementById('login-screen'),
        appContainer: document.getElementById('app-container'),
        welcomeMessage: document.getElementById('welcome-message')
      },
      
      init() {
        this.handleTelegramLogin();
      },
      
      handleTelegramLogin() {
          const tg = window.Telegram.WebApp;
          tg.ready();

          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
              this.state.telegramUser = tg.initDataUnsafe.user;
              this.elements.welcomeMessage.innerText = `স্বাগতম, ${this.state.telegramUser.first_name}!`;
              console.log("Logged in user:", this.state.telegramUser);
              this.initializeFirebase();
          } else {
              this.elements.loginScreen.innerHTML = `<div class="error-message">টেলিগ্রাম ব্যবহারকারীর তথ্য পাওয়া যায়নি। দয়া করে টেলিগ্রাম অ্যাপ থেকে খুলুন।</div>`;
              console.error("Telegram user data not found.");
          }
      },
      
      initializeFirebase() {
        firebase.initializeApp(this.firebaseConfig);
        const db = firebase.database();
        const videosRef = db.ref('/videos'); // Assumes your videos are stored in a 'videos' node

        videosRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && Array.isArray(data)) {
                // Filter out any null/empty entries from Firebase
                this.config.videos = data.filter(video => video && video.url);
                this.showApp();
            } else {
                this.elements.loginScreen.innerHTML = `<div class="error-message">ডাটাবেস থেকে কোনো ভিডিও খুঁজে পাওয়া যায়নি।</div>`;
                console.error("No video data found in Firebase or data is not an array.");
            }
        }, (error) => {
            this.elements.loginScreen.innerHTML = `<div class="error-message">ডাটাবেস সংযোগে সমস্যা হয়েছে।</div>`;
            console.error("Firebase read failed: " + error.code);
        });
      },

      showApp() {
        this.elements.loginScreen.style.display = 'none';
        this.elements.appContainer.classList.add('visible');

        this.renderVideoFeed();
        if (this.config.videos.length > 0) {
            this.loadVideo(0, true);
        } else {
             this.elements.playerContainer.innerHTML = `<div class="error-message">কোনো ভিডিও নেই।</div>`;
        }
        this.addDoubleTapListener();
      },

      renderVideoFeed() {
        this.elements.videoFeed.innerHTML = '';
        this.config.videos.forEach((video, index) => {
          if (!video.url) return;
          const card = document.createElement('div');
          card.className = 'video-card';
          card.onclick = () => this.loadVideo(index, true);
          card.innerHTML = `
            <div class="thumbnail-container">
              <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
              <span class="video-duration">${video.duration}</span>
            </div>
            <div class="video-meta">
              <h3 class="video-title">${video.title}</h3>
              <div class="video-info">${video.channel}</div>
            </div>`;
          this.elements.videoFeed.appendChild(card);
        });
      },

      loadVideo(index, autoplay = false) {
        if (this.state.currentHlsInstance) {
          this.state.currentHlsInstance.destroy();
        }
        this.state.currentHlsInstance = null;
        this.state.activeVideoElement = null;
        this.elements.playerContainer.innerHTML = `<div class="loading-indicator">লোড হচ্ছে...</div>`;
        this.highlightActiveCard(index);

        const videoData = this.config.videos[index];
        const url = videoData.url;

        if (this.isVideoType(url, 'direct')) {
          this.createDirectVideoPlayer(url, autoplay);
        } else if (this.isVideoType(url, 'hls')) {
          this.createHlsPlayer(url, autoplay);
        } else {
          this.createIframePlayer(url, autoplay);
        }
      },
      
      createIframePlayer(url, autoplay) {
        const iframe = document.createElement('iframe');
        const urlObj = new URL(url);
        if (autoplay) {
            urlObj.searchParams.set('autoplay', '1');
            urlObj.searchParams.set('muted', '1'); // Mute for autoplay in iframes
        }
        iframe.src = urlObj.toString();
        iframe.allow = 'autoplay; fullscreen; picture-in-picture';
        iframe.setAttribute('allowfullscreen', '');
        
        this.elements.playerContainer.innerHTML = '';
        this.elements.playerContainer.appendChild(iframe);
      },

      createHlsPlayer(url, autoplay) {
        const video = this.createVideoElement(autoplay);
        this.elements.playerContainer.innerHTML = ''; 

        if (Hls.isSupported()) {
          const hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(video);
          this.state.currentHlsInstance = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          video.src = url;
        } else {
          this.elements.playerContainer.innerHTML = `<div class="error-message">HLS সাপোর্ট করে না।</div>`;
          return;
        }
        
        this.elements.playerContainer.appendChild(video);
        this.state.activeVideoElement = video;
      },

      createDirectVideoPlayer(url, autoplay) {
        const video = this.createVideoElement(autoplay);
        video.src = url;
        
        this.elements.playerContainer.innerHTML = '';
        this.elements.playerContainer.appendChild(video);
        this.state.activeVideoElement = video;
      },
      
      createVideoElement(autoplay) {
        const video = document.createElement('video');
        video.autoplay = autoplay;
        video.muted = true; // IMPORTANT for autoplay to work
        video.playsInline = true; // Important for iOS
        video.controls = true;
        video.preload = 'metadata'; 
        return video;
      },

      addDoubleTapListener() {
        this.elements.playerContainer.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - this.state.lastTap;
            if (tapLength < 300 && tapLength > 0) {
                if (!this.state.activeVideoElement) return;

                const rect = e.target.getBoundingClientRect();
                const tapPosition = (e.changedTouches[0].clientX - rect.left) / rect.width;

                if (tapPosition > 0.5) { // ডান দিকে ট্যাপ
                    this.state.activeVideoElement.currentTime += 10;
                } else { // বাম দিকে ট্যাপ
                    this.state.activeVideoElement.currentTime -= 10;
                }
                e.preventDefault();
            }
            this.state.lastTap = currentTime;
        });
      },

      highlightActiveCard(index) {
        const allCards = this.elements.videoFeed.querySelectorAll('.video-card');
        allCards.forEach((card, i) => {
          card.classList.toggle('active', i === index);
        });
      },

      isVideoType(url, type) {
        const patterns = {
          hls: /\.m3u8(\?|$)/i,
          direct: /\.(mp4|webm|ogg)(\?|$)/i
        };
        return patterns[type] ? patterns[type].test(url) : false;
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      VideoPlayerApp.init();
    });

  </script>

  <div id="container-8a6b3d5354aa7bbf803c2c5809ea5261"></div>
  <script async="async" data-cfasync="false" src="//pl27789452.revenuecpmgate.com/8a6b3d5354aa7bbf803c2c5809ea5261/invoke.js"></script>

</body>
</html>
